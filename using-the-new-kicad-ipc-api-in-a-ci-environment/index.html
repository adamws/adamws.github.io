<!doctype html><html><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:url" content="https://adamws.github.io/using-the-new-kicad-ipc-api-in-a-ci-environment/"><meta property="og:site_name" content="adamws.github.io"><meta property="og:title" content="Using the new KiCad IPC API in a CI environment"><meta property="og:description" content="KiCad 9 introduced a new IPC API. The old SWIG-based Python bindings are now deprecated and are planned for removal in the next major release. Plugin developers are encouraged to start migrating.
The old API has one major advantage over the new one from a testing and continuous integration perspective - it works without running a GUI application and requires no extra setup for use in Docker containers or CI agent machines. Currently, the new API requires running instance of the PCB Editor. Although there are plans to enable headless mode via kicad-cli, at the time of writing, the only way to use the new API is by launching pcbnew (the GUI application) first."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-03-22T00:00:00+00:00"><meta property="article:modified_time" content="2025-03-22T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Using the new KiCad IPC API in a CI environment"><meta name=twitter:description content="KiCad 9 introduced a new IPC API. The old SWIG-based Python bindings are now deprecated and are planned for removal in the next major release. Plugin developers are encouraged to start migrating.
The old API has one major advantage over the new one from a testing and continuous integration perspective - it works without running a GUI application and requires no extra setup for use in Docker containers or CI agent machines. Currently, the new API requires running instance of the PCB Editor. Although there are plans to enable headless mode via kicad-cli, at the time of writing, the only way to use the new API is by launching pcbnew (the GUI application) first."><script async src="https://www.googletagmanager.com/gtag/js?id=G-47SFRLYXCP"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-47SFRLYXCP")}</script><script defer src=https://cloud.umami.is/script.js data-website-id=dbdd840e-6074-41d4-8a10-7985bb486522></script><title>adamws.github.io - Using the new KiCad IPC API in a CI environment
</title><link rel=stylesheet href=https://adamws.github.io/css/style.css></head><script></script><body><div id=content><div class=post><h1>Using the new KiCad IPC API in a CI environment</h1><p>KiCad 9 introduced a new <a href=https://dev-docs.kicad.org/en/apis-and-binding/ipc-api/index.html>IPC API</a>.
The old SWIG-based Python bindings are now deprecated and are planned for removal in the next major
release. Plugin developers are encouraged to start migrating.</p><p>The old API has one major advantage over the new one from a testing and continuous integration
perspective - it works without running a GUI application and requires no extra setup for use in
Docker containers or CI agent machines.
Currently, the new API requires running instance of the <em>PCB Editor</em>. Although there are plans
to enable headless mode via <code>kicad-cli</code>, at the time of writing, the only way to use the new API is
by launching <code>pcbnew</code> (the GUI application) first.</p><p>Here&rsquo;s an example of how to work around this limitation and use the IPC API in Python within
Linux-based Docker containers:</p><ol><li><p>Add <a href=https://en.wikipedia.org/wiki/Xvfb><code>xvfb</code></a> to the Docker image. This is a virtual display.</p></li><li><p>Add the <a href=https://github.com/ponty/pyvirtualdisplay><code>PyVirtualDisplay</code></a> Python package
to your requirements. This wrapper simplifies using <code>xvfb</code>.</p></li><li><p>Write some code that uses the above tools to start the <code>pcbnew</code> process. For example:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#cf222e>import</span> <span style=color:#24292e>json</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>import</span> <span style=color:#24292e>os</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>import</span> <span style=color:#24292e>subprocess</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>import</span> <span style=color:#24292e>time</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>from</span> <span style=color:#24292e>pathlib</span> <span style=color:#cf222e>import</span> Path
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>import</span> <span style=color:#24292e>kipy</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>from</span> <span style=color:#24292e>pyvirtualdisplay.smartdisplay</span> <span style=color:#cf222e>import</span> DisplayTimeoutError<span style=color:#1f2328>,</span> SmartDisplay
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>class</span> <span style=color:#1f2328>LinuxVirtualScreenManager</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>def</span> __enter__<span style=color:#1f2328>(</span><span style=color:#6a737d>self</span><span style=color:#1f2328>):</span>
</span></span><span style=display:flex><span>        <span style=color:#6a737d>self</span><span style=color:#0550ae>.</span>display <span style=color:#0550ae>=</span> SmartDisplay<span style=color:#1f2328>(</span>backend<span style=color:#0550ae>=</span><span style=color:#0a3069>&#34;xvfb&#34;</span><span style=color:#1f2328>,</span> size<span style=color:#0550ae>=</span><span style=color:#1f2328>(</span><span style=color:#0550ae>1024</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>768</span><span style=color:#1f2328>))</span>
</span></span><span style=display:flex><span>        <span style=color:#6a737d>self</span><span style=color:#0550ae>.</span>display<span style=color:#0550ae>.</span>start<span style=color:#1f2328>()</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>return</span> <span style=color:#6a737d>self</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>def</span> __exit__<span style=color:#1f2328>(</span><span style=color:#6a737d>self</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>*</span>exc<span style=color:#1f2328>):</span>
</span></span><span style=display:flex><span>        <span style=color:#6a737d>self</span><span style=color:#0550ae>.</span>display<span style=color:#0550ae>.</span>stop<span style=color:#1f2328>()</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>return</span> <span style=color:#cf222e>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>def</span> <span style=color:#6639ba>screenshot</span><span style=color:#1f2328>(</span><span style=color:#6a737d>self</span><span style=color:#1f2328>,</span> path<span style=color:#1f2328>):</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>try</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>            img <span style=color:#0550ae>=</span> <span style=color:#6a737d>self</span><span style=color:#0550ae>.</span>display<span style=color:#0550ae>.</span>waitgrab<span style=color:#1f2328>(</span>timeout<span style=color:#0550ae>=</span><span style=color:#0550ae>5</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>            img<span style=color:#0550ae>.</span>save<span style=color:#1f2328>(</span>path<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>            <span style=color:#cf222e>return</span> <span style=color:#cf222e>True</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>except</span> DisplayTimeoutError <span style=color:#cf222e>as</span> err<span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>            <span style=color:#6639ba>print</span><span style=color:#1f2328>(</span>err<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>            <span style=color:#cf222e>return</span> <span style=color:#cf222e>False</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>def</span> <span style=color:#6639ba>get_kicad_config_dir</span><span style=color:#1f2328>()</span> <span style=color:#0550ae>-&gt;</span> Path<span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>return</span> Path<span style=color:#0550ae>.</span>home<span style=color:#1f2328>()</span> <span style=color:#0550ae>/</span> <span style=color:#0a3069>&#34;.config/kicad/9.0&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>def</span> <span style=color:#6639ba>enable_ipc_api</span><span style=color:#1f2328>()</span> <span style=color:#0550ae>-&gt;</span> <span style=color:#cf222e>None</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>    settings_file <span style=color:#0550ae>=</span> get_kicad_config_dir<span style=color:#1f2328>()</span> <span style=color:#0550ae>/</span> <span style=color:#0a3069>&#34;kicad_common.json&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>if</span> <span style=color:#0550ae>not</span> settings_file<span style=color:#0550ae>.</span>is_file<span style=color:#1f2328>():</span>
</span></span><span style=display:flex><span>        settings_file<span style=color:#0550ae>.</span>parent<span style=color:#0550ae>.</span>mkdir<span style=color:#1f2328>(</span>parents<span style=color:#0550ae>=</span><span style=color:#cf222e>True</span><span style=color:#1f2328>,</span> exist_ok<span style=color:#0550ae>=</span><span style=color:#cf222e>True</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#57606a># Most likely, pcbnew has never been executed, so create a minimal config</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>with</span> <span style=color:#6639ba>open</span><span style=color:#1f2328>(</span>settings_file<span style=color:#1f2328>,</span> <span style=color:#0a3069>&#34;w&#34;</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>as</span> f<span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>            <span style=color:#6639ba>print</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;Creating minimal settings file&#34;</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>            min_settings <span style=color:#0550ae>=</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                <span style=color:#0a3069>&#34;api&#34;</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span><span style=color:#0a3069>&#34;enable_server&#34;</span><span style=color:#1f2328>:</span> <span style=color:#cf222e>True</span><span style=color:#1f2328>,</span> <span style=color:#0a3069>&#34;interpreter_path&#34;</span><span style=color:#1f2328>:</span> <span style=color:#0a3069>&#34;&#34;</span><span style=color:#1f2328>},</span>
</span></span><span style=display:flex><span>            <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>            json<span style=color:#0550ae>.</span>dump<span style=color:#1f2328>(</span>min_settings<span style=color:#1f2328>,</span> f<span style=color:#1f2328>,</span> indent<span style=color:#0550ae>=</span><span style=color:#0550ae>2</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>else</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>with</span> <span style=color:#6639ba>open</span><span style=color:#1f2328>(</span>settings_file<span style=color:#1f2328>,</span> <span style=color:#0a3069>&#34;r&#34;</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>as</span> f<span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>            settings <span style=color:#0550ae>=</span> json<span style=color:#0550ae>.</span>load<span style=color:#1f2328>(</span>f<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>if</span> <span style=color:#0550ae>not</span> settings<span style=color:#1f2328>[</span><span style=color:#0a3069>&#34;api&#34;</span><span style=color:#1f2328>]</span><span style=color:#0550ae>.</span>get<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;enable_server&#34;</span><span style=color:#1f2328>,</span> <span style=color:#cf222e>False</span><span style=color:#1f2328>):</span>
</span></span><span style=display:flex><span>            <span style=color:#6639ba>print</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;Enabling IPC API&#34;</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>            settings<span style=color:#1f2328>[</span><span style=color:#0a3069>&#34;api&#34;</span><span style=color:#1f2328>][</span><span style=color:#0a3069>&#34;enable_server&#34;</span><span style=color:#1f2328>]</span> <span style=color:#0550ae>=</span> <span style=color:#cf222e>True</span>
</span></span><span style=display:flex><span>            <span style=color:#cf222e>with</span> <span style=color:#6639ba>open</span><span style=color:#1f2328>(</span>settings_file<span style=color:#1f2328>,</span> <span style=color:#0a3069>&#34;w&#34;</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>as</span> f<span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>                json<span style=color:#0550ae>.</span>dump<span style=color:#1f2328>(</span>settings<span style=color:#1f2328>,</span> f<span style=color:#1f2328>,</span> indent<span style=color:#0550ae>=</span><span style=color:#0550ae>2</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>def</span> <span style=color:#6639ba>prepare_mock_fp_lib_table</span><span style=color:#1f2328>()</span> <span style=color:#0550ae>-&gt;</span> <span style=color:#cf222e>None</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a># Create a mock fp-lib-table file in the config directory if it doesn&#39;t already exist</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a># This prevents a popup on the first pcbnew run</span>
</span></span><span style=display:flex><span>    fp_lib_table_path <span style=color:#0550ae>=</span> get_kicad_config_dir<span style=color:#1f2328>()</span> <span style=color:#0550ae>/</span> <span style=color:#0a3069>&#34;fp-lib-table&#34;</span>
</span></span><span style=display:flex><span>    fp_lib_table_path<span style=color:#0550ae>.</span>parent<span style=color:#0550ae>.</span>mkdir<span style=color:#1f2328>(</span>parents<span style=color:#0550ae>=</span><span style=color:#cf222e>True</span><span style=color:#1f2328>,</span> exist_ok<span style=color:#0550ae>=</span><span style=color:#cf222e>True</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>if</span> <span style=color:#0550ae>not</span> Path<span style=color:#1f2328>(</span>fp_lib_table_path<span style=color:#1f2328>)</span><span style=color:#0550ae>.</span>is_file<span style=color:#1f2328>():</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>with</span> <span style=color:#6639ba>open</span><span style=color:#1f2328>(</span>fp_lib_table_path<span style=color:#1f2328>,</span> <span style=color:#0a3069>&#34;w&#34;</span><span style=color:#1f2328>)</span> <span style=color:#cf222e>as</span> f<span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>            f<span style=color:#0550ae>.</span>write<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;(fp_lib_table)&#34;</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>def</span> <span style=color:#6639ba>wait_for_kicad</span><span style=color:#1f2328>(</span>kicad<span style=color:#1f2328>,</span> timeout<span style=color:#1f2328>:</span> <span style=color:#6639ba>float</span><span style=color:#1f2328>,</span> interval<span style=color:#1f2328>:</span> <span style=color:#6639ba>float</span> <span style=color:#0550ae>=</span> <span style=color:#0550ae>1.0</span><span style=color:#1f2328>):</span>
</span></span><span style=display:flex><span>    start_time <span style=color:#0550ae>=</span> time<span style=color:#0550ae>.</span>time<span style=color:#1f2328>()</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>while</span> time<span style=color:#0550ae>.</span>time<span style=color:#1f2328>()</span> <span style=color:#0550ae>-</span> start_time <span style=color:#0550ae>&lt;</span> timeout<span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>try</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>            kicad<span style=color:#0550ae>.</span>ping<span style=color:#1f2328>()</span>
</span></span><span style=display:flex><span>            <span style=color:#cf222e>return</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>except</span> <span style=color:#1f2328>(</span>kipy<span style=color:#0550ae>.</span>errors<span style=color:#0550ae>.</span>ApiError<span style=color:#1f2328>,</span> kipy<span style=color:#0550ae>.</span>errors<span style=color:#0550ae>.</span>ConnectionError<span style=color:#1f2328>):</span>
</span></span><span style=display:flex><span>            <span style=color:#cf222e>pass</span>
</span></span><span style=display:flex><span>        time<span style=color:#0550ae>.</span>sleep<span style=color:#1f2328>(</span>interval<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>raise</span> TimeoutError<span style=color:#1f2328>(</span><span style=color:#0a3069>f</span><span style=color:#0a3069>&#34;KiCad did not respond within </span><span style=color:#0a3069>{</span>timeout<span style=color:#0a3069>}</span><span style=color:#0a3069> seconds.&#34;</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>if</span> __name__ <span style=color:#0550ae>==</span> <span style=color:#0a3069>&#34;__main__&#34;</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a># Prepare minimal configuration files for running pcbnew</span>
</span></span><span style=display:flex><span>    enable_ipc_api<span style=color:#1f2328>()</span>
</span></span><span style=display:flex><span>    prepare_mock_fp_lib_table<span style=color:#1f2328>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#57606a># Run pcbnew inside a virtual display</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>with</span> LinuxVirtualScreenManager<span style=color:#1f2328>()</span> <span style=color:#cf222e>as</span> mgr<span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>        p <span style=color:#0550ae>=</span> subprocess<span style=color:#0550ae>.</span>Popen<span style=color:#1f2328>(</span>
</span></span><span style=display:flex><span>            <span style=color:#1f2328>[</span><span style=color:#0a3069>&#34;pcbnew&#34;</span><span style=color:#1f2328>],</span>
</span></span><span style=display:flex><span>            env<span style=color:#0550ae>=</span>os<span style=color:#0550ae>.</span>environ<span style=color:#0550ae>.</span>copy<span style=color:#1f2328>(),</span>  <span style=color:#57606a># This is important, as it sets the DISPLAY variable</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>try</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>            kicad <span style=color:#0550ae>=</span> kipy<span style=color:#0550ae>.</span>KiCad<span style=color:#1f2328>()</span>
</span></span><span style=display:flex><span>            wait_for_kicad<span style=color:#1f2328>(</span>kicad<span style=color:#1f2328>,</span> <span style=color:#0550ae>5</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>0.2</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>            version <span style=color:#0550ae>=</span> kicad<span style=color:#0550ae>.</span>get_version<span style=color:#1f2328>()</span>
</span></span><span style=display:flex><span>            <span style=color:#6639ba>print</span><span style=color:#1f2328>(</span><span style=color:#0a3069>f</span><span style=color:#0a3069>&#34;KiCad version: </span><span style=color:#0a3069>{</span>version<span style=color:#0a3069>}</span><span style=color:#0a3069>&#34;</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>except</span> Exception <span style=color:#cf222e>as</span> e<span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>            <span style=color:#6639ba>print</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;Failed to use IPC API&#34;</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>            <span style=color:#6639ba>print</span><span style=color:#1f2328>(</span>e<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        _ <span style=color:#0550ae>=</span> mgr<span style=color:#0550ae>.</span>screenshot<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;screenshot.png&#34;</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>        p<span style=color:#0550ae>.</span>kill<span style=color:#1f2328>()</span>
</span></span></code></pre></td></tr></table></div></div><p>To verify this code, you can use the <code>admwscki/kicad-kbplacer-primary:9.0.0-jammy</code> image:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ mkdir ipc-example <span style=color:#0550ae>&amp;&amp;</span> <span style=color:#6639ba>cd</span> ipc-example
</span></span><span style=display:flex><span><span style=color:#57606a># Create ipc_example.py and copy the example code above</span>
</span></span><span style=display:flex><span>$ docker run --rm -v <span style=color:#cf222e>$(</span><span style=color:#6639ba>pwd</span><span style=color:#cf222e>)</span>:<span style=color:#cf222e>$(</span><span style=color:#6639ba>pwd</span><span style=color:#cf222e>)</span> -w <span style=color:#cf222e>$(</span><span style=color:#6639ba>pwd</span><span style=color:#cf222e>)</span> <span style=color:#0a3069>\
</span></span></span><span style=display:flex><span><span style=color:#0a3069></span>    admwscki/kicad-kbplacer-primary:9.0.0-jammy /bin/bash -c <span style=color:#0a3069>\
</span></span></span><span style=display:flex><span><span style=color:#0a3069></span>    <span style=color:#0a3069>&#34;pip3 install kicad-python PyVirtualDisplay &amp;&amp; python3 ipc_example.py&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>The container should run, install dependencies, and finish by printing version information like this:
<code>KiCad version: 9.0.0-9.0.0-2~ubuntu22.04.1</code>.
It should also produce a <code>screenshot.png</code> file in the current directory:</p><p><img src=/img/0004/screenshot.png alt=screenshot></p></li></ol><p>For a more complete example, including running on <a href=https://circleci.com/>CircleCI&rsquo;s</a> Windows
agent and better <code>pytest</code> integration, check out the changes in the kbplacer repository <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.</p><p>On Windows, the general approach is the same, with two key differences:</p><ol><li>There is no virtual display and extra OpenGL drivers must be installed.</li><li>Modifying KiCad&rsquo;s configuration files before the first run must be extended to prevent extra popups,
which apparently happen only on Windows.</li></ol><p>As a result, the kbplacer plugin now has its first test using the new API, which appears in the <code>pytest</code> report like this:</p><p><img src=/img/0004/test-report.png alt=test-report></p><p>Although having a headless KiCad mode would be ideal, using the new API in a Dockerized/CI environment is feasible.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://github.com/adamws/kicad-kbplacer/commit/b23052e6db7aa19cdf1b9e0ef50c5afede47de81>https://github.com/adamws/kicad-kbplacer/commit/b23052e6db7aa19cdf1b9e0ef50c5afede47de81</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></div><footer><a href=https://adamws.github.io/>Back to Home</a></footer></body></html>